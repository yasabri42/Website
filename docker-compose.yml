services:

  postgresql:
    container_name: postgresql
    image: postgres:alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
        - ./src/postgresql/data:/var/lib/postgresql/data
    networks:
      - django_postgresql

  django:
    container_name: django
    build:
      context: ./src/django
    env_file:
      - .env
    volumes:
        - ./src/django:/django
    depends_on:
      - postgresql
      - vault
    networks:
      - django_postgresql
      - django_nginx
      - django_vault

  nginx:
    container_name: nginx
    image: owasp/modsecurity-crs:nginx-alpine
    volumes:
      - ./src/nginx/certs:/etc/nginx/conf
      - ./src/nginx/conf/default.conf:/etc/nginx/templates/conf.d/default.conf.template
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - django
    networks:
      - django_nginx

  vault:
    container_name: vault
    build:
      context: ./src/vault
    environment:
      VAULT_ADDR: ${VAULT_ADDR}
    cap_add:
      - IPC_LOCK
    volumes:
      - ./src/vault/config/vault.hcl:/vault/config/vault.hcl
      - ./src/vault/file:/vault/file
    networks:
      - django_vault

networks:
  django_postgresql:
  django_nginx:
  django_vault: